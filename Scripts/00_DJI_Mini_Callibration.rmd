---
title: "Bias and uncertainty in estimating length with DJI Mini 2"
author: "Ana Eguiguren"
date: "2025-03-18"
output: md_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE}
#setwd("/Documents/SpermWhale_SexAge_Drone_VSC")

source("Scripts/00_DJI_Mini_Callibration_Data_Prep.R")
library(ggplot2)
library("wacolors")


```

```{r setup data, include = F}
px.length <- function(l.m, p.d, f.l = 4.25531, a.m){
  (l.m/p.d)*(f.l/a.m)
  
}

#calculate pixel length:
dat$pixel.length <- px.length(l.m=dat$length,
                              p.d = dat$pixelDimension.old,
                              a.m = dat$altitude)

dat<- dat %>% select(Date, FlightNo, imageName, timeStamp, altitudeRaw = altitude, imageWidth = ImageWidth, pixel.length, position = pos, nadir = nadir) 

dat<- dat[-which(dat$nadir==F),]

```

## Callibration data

This Dataset has 343 images of Balaena (at nadir) taken during different flights and dates.

-   altitudeRaw: the altitude indicated by DJI (zeroed at takeoff).

-   imageWidth: picture's width in pixels (1920 or 3840).

-   pixel.length: Balaena's length in pixels.

-   position: whether Balaena was in the center of the frame (pos_c) or closer to the edges (pos_o).

-   nadir: confirms that the the gimbal pitch during the screenshot was \<- 87 degrees (i.e., close to perpendicular)

```{r summary}
head(dat)
```

## Correct initial altitude

The drone altitude is zeroed the moment the rotors start, which means that the true altitude needs to add the distance from the drone's launch point to the water:

![depiction of how the true altitude from the water line is calculated](Graphical/altitude_diagram.jpeg)

*Note that, in Balaena's case, the altitude we want is the distance from the drone to the boat, so we can omit the boat height in the calculation as follows:*

```{r}
#recalculate Balaena's length in m, with new altitude 
boat.height = 1.03- 0.24# balaena's altitude over the water - toe rail

launch.chest = 1.4 # Mateo's chest height
camera.height = 0.045 # cameras distance above the base of the drone's legsfrom legs

dat$altitude.fix <- dat$altitude + launch.chest + camera.height
head(dat)
```

Next, we use the following formula to calculate Balaena's length according to the drone's data:

$$
length = \text{alpha} \times \text{true altitude} \times \text{pixel length}
$$

Where *alpha* is the camera's correction factor, estimated empirically in the lab by measuring objects of known length and distance. For the DJI Mini, *alpha* = 0.000328 at 3840, and *alpha* = 0.000656 at 1920 This equation is reflected in the following function:

```{r }
morpho.length.alpha <- function(image.width, altitude, length.pixels){
  alpha = ifelse(image.width == 3840, yes = 0.000328, no = 
                   ifelse(image.width == 1920, yes = 0.000656, no = NA))
  length = alpha * altitude * length.pixels
  return(length)
}
```

This results in the following estimated length for Balaena:

```{r}
dat$bal.length<- morpho.length.alpha(altitude = dat$altitude.fix,
                                      image.width = dat$imageWidth,
                                      length.pixels = dat$pixel.length)
summary(dat$bal.length)


```

```{r estimate, fig.cap = "Histogram of Balaena's length estimated using the DJI Mini Drone. The red line shows Balaena's True length"}
hist(dat$bal.length, breaks = 20, xlab = "estimated length of Balaena (m)", main = "")
abline(v = 12.03, col = 2, lwd = 2)
```

This means there is an under-estimate of Balaena's length of mean = 0.55 meters, and s.d. = 0.38

```{r}
dat$error <- dat$bal.length-12.03
mean(dat$error)
sd(dat$error)
```

Which correspond to the following percentages:
```{r}
mean(dat$error/12.03)*100
sd(dat$error/12.03)*100
```

## Questions

The following section models the error induced by inaccurate altitude measurements based on Burnett et al., 2018.

-   Does error vary depending on the boat's position in the frame?


-   Where should the correction factor go - is it a constant that I add to the total, or is it specifically for the altitude?

## Explore the effect of boat position:

```{r}
ggplot(dat, aes(x = factor(position), y = error))+
  geom_boxplot()
```
## Altitude experiment:

Here, I will attempt to mitigate and measure of the error comes from bad altitude estimates. So I used our knowledge of Balaena's true length, assumed all other measurements were adequate, and calculated **true altitude**, and found that the good altitudes are further away from the measured altitudes at higher altitudes. For this, I used the formula:

$$
true.altitude = \frac{true.length}{pixel.length}  \times alpha
$$

```{r}
true.altitude <- function(true.length, pixel.length, image.width){
  alpha = ifelse(image.width == 3840, yes = 0.000328, no = 
                   ifelse(image.width == 1920, yes = 0.000656, no = NA))
  t.a = (true.length/(pixel.length* alpha))
  return(t.a)
}

dat$true.altitude <- true.altitude(true.length = 12.03, 
                                   pixel.length = dat$pixel.length, 
                                   image.width = dat$imageWidth)
```

Next, I estimated the altitude error as a raw value and a percentage:

```{r}
dat$altitude.err <- dat$true.altitude - dat$altitude.fix
dat$altitude.err.p <- (dat$altitude.err/dat$true.altitude)
```

Which results in the following error distribution for the altitude in m:

```{r}
hist(dat$altitude.err, breaks = 30, xlab = "altitude error (m)", 
     main = "")

text(x = 10, y = 40, paste("mean error = ",signif(mean(dat$altitude.err), digits =3)))

text(x = 10, y = 35, paste("s.d. = ",signif(sd(dat$altitude.err), digits =3)))


```

How does this look across altitudes?

```{r}

ggplot(dat, aes(x = altitude.fix, y = true.altitude))+
  geom_point(alpha = 0.5)+
  theme(legend.position = "none")+ 
  geom_smooth(method = "lm")
  

```

Can I model true altitude based on barometric altitude?

```{r}
# 
library(nlme)

# non-hierarchical
m.nh <- gls(true.altitude ~ altitude.fix,, data = dat, method = "ML")
summary(m.nh) #AIC = 1405.26/ BIC = 1416.77	
```

```{r}
# model random intercept :
m.rand.int <- lme(true.altitude ~ altitude.fix, data = dat, method = "ML",
              random = ~1|Date)# 
summary(m.rand.int) # AIC = 1389.933 BIC = 1405.284	- probably yes?


intervals(m.rand.int, level = 0.95)

```


```{r}
#model random intercept and slope:
m.rand <- lme(true.altitude ~ altitude.fix, data = dat, method = "ML",
              random = ~altitude.fix|Date)# 
summary(m.rand) # AIC = 1389.933 BIC = 1405.284	- probably yes?


```


Compare across models (altitude):

```{r}
dat$fit.nh <- fitted(m.nh) #non-hierarchical
dat$fit.rand.int <- fitted(m.rand.int) #random intercepts
dat$fit.rand <- fitted(m.rand) # random slopes

# error estimates
dat$altitude.err.nh <- dat$fit.nh - dat$true.altitude
dat$altitude.err.rand.int <- dat$fit.rand.int - dat$true.altitude
dat$altitude.err.rand <- dat$fit.rand - dat$true.altitude






dat_long.alt <- dat %>%
  pivot_longer(
    cols = starts_with("altitude.err"), 
    names_to = "correction_type", 
    values_to = "altitude_error"
  )

dat_long.alt.summary<-dat_long.alt %>%
  group_by(correction_type)%>%
  summarise(mean_err = mean(altitude_error), 
            sd_err = sd(altitude_error),
            ci_lo = unname(quantile(altitude_error, probs = 0.025)),
            ci_hi = unname(quantile(altitude_error, probs = 0.095)), 
            ci_width = ci_hi- ci_lo)%>%
  filter(correction_type!="altitude.err.p")

write.csv(dat_long.alt.summary,"/Users/anacristinaeguigurenburneo/Documents/SpermWhale_SexAge_Drone_VSC/Data/Processed_Data/Altitude_error_correction_summary.csv")

```





```{r}
#compare measurement errors from three models
dat$length.corrected.nh<- morpho.length.alpha(altitude =dat$fit.nh,
                                      image.width = dat$imageWidth,
                                      length.pixels = dat$pixel.length)


dat$length.corrected.rand.int<- morpho.length.alpha(altitude =dat$fit.rand.int,
                                      image.width = dat$imageWidth,
                                      length.pixels = dat$pixel.length)



dat$length.corrected.rand<- morpho.length.alpha(altitude =dat$fit.rand,
                                      image.width = dat$imageWidth,
                                      length.pixels = dat$pixel.length)


dat$length.corrected.0 <- dat$bal.length #uncorrected




dat_long <- dat %>%
  pivot_longer(
    cols = starts_with("length.corrected"), 
    names_to = "correction_type", 
    values_to = "corrected_length"
  )%>%
  mutate(error = corrected_length - 12.03, 
         error_p = 100*(error/12.03))


```

```{r}
dat_long.err.summary<- dat_long %>%
  group_by(correction_type)%>%
  summarise(mean_err = mean(error), 
            mean_err_p= mean(error_p), 
            quant_025 = quantile(error, probs = 0.025), 
            quant_975 = quantile(error, probs = 0.975),
            ic_range = quant_975-quant_025, 
            sd = sd(error_p))
dat_long.err.summary

write.csv(dat_long.err.summary, "/Users/anacristinaeguigurenburneo/Documents/SpermWhale_SexAge_Drone_VSC/Data/Processed_Data/Measurement_error_correction_summary.csv")

```



```{r}
dat_long %>%
  group_by(correction_type)%>%
  summarise(mean_err = mean(error), 
            mean_err_p = mean(mean_err), 
            quant_5 = quantile(error_p, probs = 0.025), 
            quant_95 = quantile(error_p, probs = 0.975),
            ic_range = quant_95-quant_5, 
            sd = sd(error_p))
```
How does **percent** error compare to altitude?

```{r}

ggplot(dat, aes(x = true.altitude, y = altitude.err.p))+
  geom_point(alpha = 0.5)+
  theme(legend.position = "none")+ 
  geom_smooth(method = "lm")

```

Which looks like error is proportional, more than an added constant

```{r}
mean(dat$altitude.err.p)
sd(dat$altitude.err.p)
quantile(dat$altitude.err.p, probs = c(0.025, 0.975))

```



So if I add the result from the gls non.hierarchical model:

```{r}
dat$altitude.corr <-1.403227 + dat$altitude.fix*1.017178 



dat$bal.length.c<- morpho.length.alpha(altitude =dat$altitude.corr,
                                      image.width = dat$imageWidth,
                                      length.pixels = dat$pixel.length)
quantile(dat$bal.length.c-12.03, probs = c(0.05, 0.5, 0.95))
quantile(dat$bal.length.c, probs = c(0.0975)) - quantile(dat$bal.length.c, probs = c(0.025))

```

inspect the mean and spread of corrected altitude measurements error


```{r}

dat$altitude.corr.err <- dat$altitude.corr - dat$true.altitude
mean(dat$altitude.corr.err)
sd(dat$altitude.corr.err)
quantile(dat$altitude.corr.err, probs = c(0.025, 0.975))
```




```{r}
hist(dat$bal.length.c, breaks = 30, main = "", xlab = "estimated length")
abline(v = 12.03, col = 2, lwd = 2)

text(x = 13, y = 40, paste("mean = ",mean(dat$bal.length.c)))

text(x = 13, y = 35, paste("s.d. = ",sd(dat$bal.length.c)))
text(x = 13, y = 30 , paste("CV% = ", 100*sd(dat$bal.length.c)/mean(dat$bal.length.c) ))

```

Look at error pre & post correction:

```{r}
dat$length.error.c <- dat$bal.length.c - 12.03 # corrected error raw
dat$length.error.c.p <- (dat$length.error.c/12.03 )*100

e <- c(dat$length.error.c.p,dat$length.error.p)
d <- data.frame(perc.error = e, error.type = rep(c("corrected", "uncorrected"), each = length(dat$bal.length)))

```

```{r fig3, fig.width = 15, fig.width = 2, fig.align="center"}

ggplot(d, aes(x = error.type, y = perc.error, fill = error.type))+
  geom_boxplot()+
  scale_y_continuous(limits=c(-20,20))+
  labs(y = "Error %", x = "Error type")+
   theme_classic()+
  theme(legend.position = "null")+
  geom_hline(yintercept = 0)+
  geom_hline(yintercept = -5, linetype = "dashed", colour = "gray")+
  geom_hline(yintercept = 5, linetype = "dashed", colour = "gray")+
  scale_fill_wa_d("rainier")


```

This looks pretty reasonable!

What is the 95% confidence interval:

```{r}
mean(dat$length.error.c.p)
sd(dat$length.error.c.p)


quantile(dat$length.error.c, probs=c(0.05, 0.95))


```


Save details:
```{r , include=FALSE}
library(wacolors)
setwd( "C:/Users/balae/Documents/SpermWhale_SexAge_Drone_VSC")
p1 <-ggplot(d, aes(x = error.type, y = perc.error, fill = error.type))+
  geom_boxplot()+
  scale_y_continuous(limits=c(-20,20))+
  labs(y = "Error %", x = "Error type")+
   theme_classic()+
  theme(legend.position = "null")+
  geom_hline(yintercept = 0)+
  geom_hline(yintercept = -5, linetype = "dashed", colour = "gray")+
  geom_hline(yintercept = 5, linetype = "dashed", colour = "gray")+
  scale_fill_wa_d("rainier")

ggsave("Figures/measuerement_error_corrected.png",
       p1, width = 3, height = 3)

```